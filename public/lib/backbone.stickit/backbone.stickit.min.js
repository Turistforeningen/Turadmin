//
// backbone.stickit - v0.7.0
// The MIT License
// Copyright (c) 2012 The New York Times, CMS Group, Matthew DeLambo <delambo@gmail.com> 
//
(function(t){"function"==typeof define&&define.amd?define(["underscore","backbone"],t):"object"==typeof exports?t(require("underscore"),require("backbone")):t(_,Backbone)})(function(t,e){e.Stickit={_handlers:[],addHandler:function(e){e=t.map(t.flatten([e]),function(e){return t.extend({updateModel:!0,updateView:!0,updateMethod:"text"},e)}),this._handlers=this._handlers.concat(e)}},t.extend(e.View.prototype,{_modelBindings:null,unstickit:function(e){var n=[];t.each(this._modelBindings,function(t,i){return e&&t.model!==e?!1:(t.model.off(t.event,t.fn),n.push(t.model),delete this._modelBindings[i],void 0)},this),t.invoke(t.uniq(n),"trigger","stickit:unstuck",this.cid),this._modelBindings=t.compact(this._modelBindings),this.$el.off(".stickit"+(e?"."+e.cid:""))},stickit:function(e,n){var a=e||this.model,p=".stickit."+a.cid,f=n||t.result(this,"bindings")||{};this._modelBindings||(this._modelBindings=[]),this.unstickit(a),t.each(f,function(e,n){var v,g,b,m,k=f[n]||{},_=t.uniqueId();v=":el"===n?this.$el:this.$(n),v.length&&(t.isString(k)&&(k={observe:k}),t.isFunction(k.observe)&&(k.observe=k.observe.call(this)),m=u(v,k),b=m.observe,m.bindId=_,m.view=this,g=t.extend({stickitChange:m},m.setOptions),c(this,v,m,a,b),d(this,v,m,a,b),b&&(t.each(m.events,function(e){var i=e+p,r=function(e){var n=m.getVal.call(this,v,e,m,t.rest(arguments));o(this,m.updateModel,n,e,m)&&s(a,b,n,g,this,m)};r=t.bind(r,this),":el"===n?this.$el.on(i,r):this.$el.on(i,n,r)},this),t.each(t.flatten([b]),function(t){r(a,this,"change:"+t,function(t,e,n){var i=n&&n.stickitChange&&n.stickitChange.bindId||null;i!==_&&h(this,v,m,l(t,b,m,this),t)})},this),h(this,v,m,l(a,b,m,this),a,!0)),a.once("stickit:unstuck",function(t){t===this.cid&&i(this,m.destroy,v,a,m)},this),i(this,m.initialize,v,a,m))},this);var v=this.remove;this.remove=function(){var e=this;return this.unstickit(),v&&(e=v.apply(this,t.rest(arguments))),e}}});var n=function(e,n){var i=(n||"").split("."),a=t.reduce(i,function(t,e){return t[e]},e);return null==a?e:a},i=function(e,i){return i?(t.isString(i)?n(e,i):i).apply(e,t.rest(arguments,2)):void 0},a=function(t){return t.find("option").not(function(){return!this.selected})},o=function(e,n){return t.isBoolean(n)?n:t.isFunction(n)||t.isString(n)?i.apply(this,arguments):!1},r=function(t,e,n,i){t.on(n,i,e),e._modelBindings.push({model:t,event:n,fn:i})},s=function(e,n,a,o,r,s){var l={};s.onSet&&(a=i(r,s.onSet,a,s)),s.set?i(r,s.set,n,a,o,s):(l[n]=a,t.isArray(n)&&t.isArray(a)&&(l=t.reduce(n,function(e,n,i){return e[n]=t.has(a,i)?a[i]:null,e},{})),e.set(l,o))},l=function(e,n,a,o){var r,s=function(t){return e[a.escape?"escape":"get"](t)},l=function(t){return null==t?"":t};return r=t.isArray(n)?t.map(n,s):s(n),a.onGet&&(r=i(o,a.onGet,r,a)),t.isArray(r)?t.map(r,l):l(r)},u=e.Stickit.getConfiguration=function(n,i){var a=[{updateModel:!1,updateMethod:"text",update:function(t,e,n,i){t[i.updateMethod]&&t[i.updateMethod](e)},getVal:function(t,e,n){return t[n.updateMethod]()}}];a=a.concat(t.filter(e.Stickit._handlers,function(t){return n.is(t.selector)})),a.push(i);var o=t.extend.apply(t,a);return o.visible&&!t.has(o,"updateView")?o.updateView=!1:t.has(o,"updateView")||(o.updateView=!0),delete o.selector,o},c=function(e,n,i,a,o){var s=["autofocus","autoplay","async","checked","controls","defer","disabled","hidden","indeterminate","loop","multiple","open","readonly","required","scoped","selected"];t.each(i.attributes||[],function(i){var u,c,d="";i=t.clone(i),u=i.observe||(i.observe=o),c=function(){var o=t.indexOf(s,i.name,!0)>-1?"prop":"attr",r=l(a,u,i,e);"class"===i.name?(n.removeClass(d).addClass(r),d=r):n[o](i.name,r)},t.each(t.flatten([u]),function(t){r(a,e,"change:"+t,c)}),c()})},d=function(e,n,a,o,s){if(null!=a.visible){var u=function(){var r=a.visible,u=a.visibleFn,c=l(o,s,a,e),d=!!c;(t.isFunction(r)||t.isString(r))&&(d=!!i(e,r,c,a)),u?i(e,u,n,d,a):n.toggle(d)};t.each(t.flatten([s]),function(t){r(o,e,"change:"+t,u)}),u()}},h=function(t,e,n,a,r,s){o(t,n.updateView,a,n)&&(i(t,n.update,e,a,r,n),s||i(t,n.afterUpdate,e,a,n))};e.Stickit.addHandler([{selector:'[contenteditable="true"]',updateMethod:"html",events:["input","change"]},{selector:"input",events:["propertychange","input","change"],update:function(t,e){t.val(e)},getVal:function(t){return t.val()}},{selector:"textarea",events:["propertychange","input","change"],update:function(t,e){t.val(e)},getVal:function(t){return t.val()}},{selector:'input[type="radio"]',events:["change"],update:function(t,e){t.filter('[value="'+e+'"]').prop("checked",!0)},getVal:function(t){return t.filter(":checked").val()}},{selector:'input[type="checkbox"]',events:["change"],update:function(n,i){if(n.length>1)i||(i=[]),n.each(function(n,a){var o=e.$(a),r=t.indexOf(i,o.val())>-1;o.prop("checked",r)});else{var a=t.isBoolean(i)?i:i===n.val();n.prop("checked",a)}},getVal:function(n){var i;if(n.length>1)i=t.reduce(n,function(t,n){var i=e.$(n);return i.prop("checked")&&t.push(i.val()),t},[]);else{i=n.prop("checked");var a=n.val();"on"!==a&&null!=a&&(i=i?n.val():null)}return i}},{selector:"select",events:["change"],update:function(a,o,r,s){var l,u=s.selectOptions,c=u&&u.collection||void 0,d=a.prop("multiple");if(!u){u={};var h=function(t){return t.map(function(){return{value:this.value,label:this.text}}).get()};a.find("optgroup").length?(c={opt_labels:[]},a.find("> option").length&&(c.opt_labels.push(void 0),t.each(a.find("> option"),function(t){c[void 0]=h(e.$(t))})),t.each(a.find("optgroup"),function(t){var n=e.$(t).attr("label");c.opt_labels.push(n),c[n]=h(e.$(t).find("option"))})):c=h(a.find("option"))}u.valuePath=u.valuePath||"value",u.labelPath=u.labelPath||"label";var p=function(i,a,o){t.each(i,function(i){var r=e.$("<option/>"),s=i,l=function(e,n){r.text(e),s=n,r.data("stickit_bind_val",s),t.isArray(s)||t.isObject(s)||r.val(s)};"__default__"===i?l(u.defaultOption.label,u.defaultOption.value):l(n(i,u.labelPath),n(i,u.valuePath)),!d&&null!=s&&null!=o&&s===o||t.isObject(o)&&t.isEqual(s,o)?r.prop("selected",!0):d&&t.isArray(o)&&t.each(o,function(e){t.isObject(e)&&(e=n(e,u.valuePath)),(e===s||t.isObject(e)&&t.isEqual(s,e))&&r.prop("selected",!0)}),a.append(r)})};a.html("");var f=function(t,e){var i=window;return 0===e.indexOf("this.")&&(i=t),e=e.replace(/^[a-z]*\.(.+)$/,"$1"),n(i,e)};if(l=t.isString(c)?f(this,c):t.isFunction(c)?i(this,c,a,s):c,l instanceof e.Collection&&(l=l.toJSON()),u.defaultOption&&p(["__default__"],a),t.isArray(l))p(l,a,o);else if(l.opt_labels)t.each(l.opt_labels,function(t){var n=e.$("<optgroup/>").attr("label",t);p(l[t],n,o),a.append(n)});else{var v,g=[];for(var b in l)v={},v[u.valuePath]=b,v[u.labelPath]=l[b],g.push(v);p(t.sortBy(g,u.comparator||u.labelPath),a,o)}},getVal:function(t){var n;return n=t.prop("multiple")?e.$(a(t).map(function(){return e.$(this).data("stickit_bind_val")})).get():a(t).data("stickit_bind_val")}}])});